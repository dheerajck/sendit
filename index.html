<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SendIt - P2P File Sharing</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1f1f1f;
      --bg-tertiary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --accent: #8c52ff;
      --accent-hover: #a375ff;
      --error: #ff5252;
      --success: #4caf50;
      --border-radius: 8px;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 800px;
      padding: 20px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--accent);
    }

    .tagline {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .card {
      background-color: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }

    h2 {
      color: var(--text-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      font-size: 1.2rem;
    }

    h2 i {
      margin-right: 10px;
      color: var(--accent);
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid #444;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(140, 82, 255, 0.2);
    }

    .btn {
      padding: 12px 16px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .peer-id-display {
      background-color: var(--bg-tertiary);
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .peer-id-value {
      font-weight: bold;
      color: var(--accent);
    }

    .copy-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 5px;
      transition: var(--transition);
    }

    .copy-btn:hover {
      color: var(--accent);
    }

    .message-container {
      border: 1px solid #444;
      border-radius: var(--border-radius);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background-color: var(--bg-tertiary);
      margin-top: 15px;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: var(--border-radius);
      max-width: 80%;
      word-break: break-word;
    }

    .message-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .message.received {
      background-color: #2a2a2a;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }

    .message.sent {
      background-color: var(--accent);
      align-self: flex-end;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }

    .message-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .message-input {
      flex-grow: 1;
      margin: 0;
    }

    .connection-status {
      font-size: 0.9rem;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .status-disconnected {
      background-color: rgba(255, 82, 82, 0.2);
      color: #ff5252;
    }

    .status-connected {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .status-icon {
      margin-right: 6px;
      font-size: 0.8rem;
    }

    .messages {
      display: flex;
      flex-direction: column;
    }

    .system-message {
      text-align: center;
      color: var(--text-secondary);
      margin: 10px 0;
      font-style: italic;
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      margin-bottom: 15px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      background-color: var(--bg-tertiary);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .tab.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }

    .tab:hover:not(.active) {
      background-color: #353535;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .input-error {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .input-error.visible {
      display: block;
    }

    .room-display {
      background-color: var(--bg-tertiary);
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-code {
      font-weight: bold;
      color: var(--accent);
    }

    .user-info {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--bg-secondary);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      box-shadow: var(--card-shadow);
      z-index: 10;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }

    .sender-name {
      font-weight: bold;
      margin-right: 6px;
      color: var(--accent);
    }

    @media (max-width: 600px) {
      .btn-group {
        flex-direction: column;
      }

      .message {
        max-width: 90%;
      }

      .tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">SendIt</div>
      <p class="tagline">Secure P2P Messaging & File Sharing</p>
    </header>

    <div id="setup-card" class="card">
      <div class="connection-status status-disconnected">
        <span class="status-icon"><i class="fas fa-circle"></i></span>
        <span id="connection-text">Not connected</span>
      </div>

      <div class="tabs">
        <div class="tab active" id="create-tab" onclick="switchTab('create')">
          <i class="fas fa-plus-circle"></i> Create Room
        </div>
        <div class="tab" id="join-tab" onclick="switchTab('join')">
          <i class="fas fa-sign-in-alt"></i> Join Room
        </div>
      </div>

      <div id="create-content" class="tab-content active">
        <h2><i class="fas fa-user-plus"></i> Create a Room</h2>
        <div class="input-group">
          <input id="host-username" placeholder="Enter your username (e.g. alex123)">
          <div id="username-error" class="input-error">This username is already taken</div>
        </div>
        <button class="btn" onclick="createRoom()">
          <i class="fas fa-door-open"></i> Create Room
        </button>

        <div id="room-info" style="display: none;">
          <div class="room-display">
            <div>
              <div>Room Code:</div>
              <div class="room-code" id="room-code">Not created yet</div>
            </div>
            <button class="copy-btn" onclick="copyRoomCode()">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <p>Share this code with others to let them join your room</p>
        </div>
      </div>

      <div id="join-content" class="tab-content">
        <h2><i class="fas fa-sign-in-alt"></i> Join a Room</h2>
        <div class="input-group">
          <input id="guest-username" placeholder="Enter your username (optional)">
        </div>
        <div class="input-group">
          <input id="room-code-input" placeholder="Enter room code">
        </div>
        <button class="btn" onclick="joinRoom()">
          <i class="fas fa-door-open"></i> Join Room
        </button>
      </div>
    </div>

    <div id="chat-card" class="card" style="display: none;">
      <div id="user-info" class="user-info">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <span id="display-username">Not Set</span>
      </div>

      <h2><i class="fas fa-comment-alt"></i> Messages</h2>
      <div class="message-container" id="messages">
        <div class="messages"></div>
      </div>

      <div class="message-form">
        <input id="message" class="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
        <button class="btn" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>

      <button class="btn" style="margin-top: 10px;" onclick="leaveRoom()">
        <i class="fas fa-sign-out-alt"></i> Leave Room
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer = null;
    let conn = null;
    let username = '';
    let isRoomCreator = false;

    // Check if the network is Wi-Fi (using Network Information API if available)
    function isWiFiNetwork() {
      if (navigator.connection && navigator.connection.type) {
        return navigator.connection.type === 'wifi';
      }
      // Fallback: Assume Wi-Fi if API is not available
      return true;
    }

    // Switch between tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`${tabName}-content`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Create a room (host)
    function createRoom() {
      if (!isWiFiNetwork()) {
        addSystemMessage('Please connect to a Wi-Fi network for optimal performance.');
        return;
      }

      username = document.getElementById('host-username').value.trim();
      if (!username) {
        document.getElementById('username-error').textContent = 'Please enter a username';
        document.getElementById('username-error').classList.add('visible');
        return;
      }

      isRoomCreator = true;

      if (peer) {
        peer.destroy();
      }

      const roomCode = username;

      peer = new Peer(roomCode, {
        config: {
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
          iceCandidatePoolSize: 10
        }
      });

      // Filter ICE candidates to prioritize Wi-Fi
      peer.on('icecandidate', (event) => {
        if (event.candidate) {
          const candidate = event.candidate.candidate;
          // Simplified Wi-Fi IP check (adjust based on your network)
          if (candidate.includes('192.168.') || candidate.includes('10.')) {
            console.log('Using Wi-Fi candidate:', candidate);
          } else {
            console.log('Ignoring non-Wi-Fi candidate:', candidate);
            return;
          }
        }
      });

      peer.on('open', (id) => {
        document.getElementById('room-code').textContent = roomCode;
        document.getElementById('room-info').style.display = 'block';
        document.getElementById('display-username').textContent = username;

        addSystemMessage(`Room created! Your room code: ${roomCode}`);
        updateConnectionStatus('waiting');
      });

      peer.on('error', (err) => {
        if (err.type === 'unavailable-id') {
          document.getElementById('username-error').textContent = 'Username already taken. Try another username.';
          document.getElementById('username-error').classList.add('visible');
        } else {
          addSystemMessage(`Error: ${err.type} - ${err.message}`);
        }
        updateConnectionStatus('error');
      });

      peer.on('connection', (connection) => {
        conn = connection;
        setupConnection();

        const guestUsername = connection.metadata ? connection.metadata.username : 'Guest';
        addSystemMessage(`${guestUsername} has joined the room!`);
        updateConnectionStatus('connected');

        document.getElementById('setup-card').style.display = 'none';
        document.getElementById('chat-card').style.display = 'block';
      });
    }

    // Join existing room (guest)
    function joinRoom() {
      if (!isWiFiNetwork()) {
        addSystemMessage('Please connect to a Wi-Fi network for optimal performance.');
        return;
      }

      const roomCode = document.getElementById('room-code-input').value.trim();
      if (!roomCode) {
        addSystemMessage('Please enter a room code.');
        return;
      }

      username = document.getElementById('guest-username').value.trim();
      if (!username) {
        username = 'Guest' + Math.floor(Math.random() * 1000);
      }

      document.getElementById('display-username').textContent = username;

      if (peer) {
        peer.destroy();
      }

      const guestId = `guest_${username}_${Math.random().toString(36).substring(2, 8)}`;

      peer = new Peer(guestId, {
        config: {
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
          iceCandidatePoolSize: 10
        }
      });

      // Filter ICE candidates to prioritize Wi-Fi
      peer.on('icecandidate', (event) => {
        if (event.candidate) {
          const candidate = event.candidate.candidate;
          if (candidate.includes('192.168.') || candidate.includes('10.')) {
            console.log('Using Wi-Fi candidate:', candidate);
          } else {
            console.log('Ignoring non-Wi-Fi candidate:', candidate);
            return;
          }
        }
      });

      peer.on('open', (id) => {
        conn = peer.connect(roomCode, {
          metadata: {
            username: username
          }
        });

        setupConnection();
        addSystemMessage(`Joining room ${roomCode}...`);
        updateConnectionStatus('connecting');
      });

      peer.on('error', (err) => {
        addSystemMessage(`Error: ${err.type} - ${err.message}`);
        if (err.type === 'peer-unavailable') {
          addSystemMessage('Room not found. Check the code and try again.');
        }
        updateConnectionStatus('error');
      });
    }

    // Setup data connection for messaging
    function setupConnection() {
      conn.on('open', () => {
        addSystemMessage('Connection established!');
        updateConnectionStatus('connected');

        document.getElementById('setup-card').style.display = 'none';
        document.getElementById('chat-card').style.display = 'block';
      });

      conn.on('data', (data) => {
        if (typeof data === 'object' && data.type === 'system') {
          addSystemMessage(data.message);
        } else if (typeof data === 'object' && data.type === 'message') {
          addReceivedMessage(data.text, data.sender);
        } else {
          addReceivedMessage(data, conn.metadata?.username || 'Unknown');
        }
      });

      conn.on('close', () => {
        addSystemMessage('Connection closed.');
        updateConnectionStatus('disconnected');
      });

      conn.on('error', (err) => {
        addSystemMessage('Connection error: ' + err);
        updateConnectionStatus('error');
      });
    }

    // Leave current room
    function leaveRoom() {
      if (conn) {
        conn.close();
      }
      if (peer) {
        peer.destroy();
        peer = null;
      }

      document.getElementById('setup-card').style.display = 'block';
      document.getElementById('chat-card').style.display = 'none';
      document.querySelector('.messages').innerHTML = '';
      document.getElementById('room-info').style.display = 'none';
      document.getElementById('username-error').classList.remove('visible');
      document.getElementById('host-username').value = '';
      document.getElementById('guest-username').value = '';
      document.getElementById('room-code-input').value = '';

      updateConnectionStatus('disconnected');
      addSystemMessage('You left the room');
    }

    // Send message
    function sendMessage() {
      const message = document.getElementById('message').value.trim();
      if (!message) return;

      if (conn && conn.open) {
        conn.send({
          type: 'message',
          text: message,
          sender: username
        });

        addSentMessage(message);
        document.getElementById('message').value = '';
      } else {
        addSystemMessage('Not connected to peer. Please connect first.');
      }
    }

    // Handle Enter key press
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Copy room code to clipboard
    function copyRoomCode() {
      const roomCode = document.getElementById('room-code').textContent;
      if (roomCode && roomCode !== 'Not created yet') {
        navigator.clipboard.writeText(roomCode)
          .then(() => {
            addSystemMessage('Room code copied to clipboard!');
          })
          .catch(err => {
            addSystemMessage('Failed to copy: ' + err);
          });
      }
    }

    // Update connection status indicator
    function updateConnectionStatus(status) {
      const statusElement = document.querySelector('.connection-status');
      const statusTextElement = document.getElementById('connection-text');

      statusElement.className = 'connection-status';

      switch(status) {
        case 'connected':
          statusElement.classList.add('status-connected');
          statusTextElement.textContent = 'Connected';
          break;
        case 'connecting':
          statusElement.classList.add('status-disconnected');
          statusTextElement.textContent = 'Connecting...';
          break;
        case 'waiting':
          statusElement.classList.add('status-disconnected');
          statusTextElement.textContent = 'Waiting for someone to join';
          break;
        case 'error':
          statusElement.classList.add('status-disconnected');
          statusTextElement.textContent = 'Connection error';
          break;
        default:
          statusElement.classList.add('status-disconnected');
          statusTextElement.textContent = 'Not connected';
      }
    }

    // Display system message
    function addSystemMessage(text) {
      const messagesEl = document.querySelector('.messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'system-message';
      messageEl.textContent = text;
      messagesEl.appendChild(messageEl);
      scrollToBottom();
    }

    // Display received message
    function addReceivedMessage(text, senderName) {
      const messagesEl = document.querySelector('.messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'message received';

      if (senderName) {
        const senderEl = document.createElement('div');
        senderEl.className = 'sender-name';
        senderEl.textContent = senderName;
        messageEl.appendChild(senderEl);
      }

      const contentEl = document.createElement('div');
      contentEl.textContent = text;
      messageEl.appendChild(contentEl);

      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = getCurrentTime();
      messageEl.appendChild(timeEl);

      messagesEl.appendChild(messageEl);
      scrollToBottom();
    }

    // Display sent message
    function addSentMessage(text) {
      const messagesEl = document.querySelector('.messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'message sent';

      const contentEl = document.createElement('div');
      contentEl.textContent = text;
      messageEl.appendChild(contentEl);

      const timeEl = document.createElement('div');
      timeEl.className = 'message-time';
      timeEl.textContent = getCurrentTime();
      messageEl.appendChild(timeEl);

      messagesEl.appendChild(messageEl);
      scrollToBottom();
    }

    // Get current time for message timestamp
    function getCurrentTime() {
      const now = new Date();
      let hours = now.getHours();
      let minutes = now.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';

      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;

      return `${hours}:${minutes} ${ampm}`;
    }

    // Scroll to bottom of message container
    function scrollToBottom() {
      const container = document.getElementById('messages');
      container.scrollTop = container.scrollHeight;
    }
  </script>
</body>
</html>