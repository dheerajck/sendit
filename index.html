<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SendIt - P2P File Sharing</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1f1f1f;
      --bg-tertiary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --accent: #8c52ff;
      --accent-hover: #a375ff;
      --error: #ff5252;
      --success: #4caf50;
      --border-radius: 8px;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 800px;
      padding: 20px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--accent);
    }

    .tagline {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .card {
      background-color: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }

    h2 {
      color: var(--text-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      font-size: 1.2rem;
    }

    h2 i {
      margin-right: 10px;
      color: var(--accent);
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid #444;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(140, 82, 255, 0.2);
    }

    .btn {
      padding: 12px 16px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .peer-id-display {
      background-color: var(--bg-tertiary);
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .peer-id-value {
      font-weight: bold;
      color: var(--accent);
    }

    .copy-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 5px;
      transition: var(--transition);
    }

    .copy-btn:hover {
      color: var(--accent);
    }

    .message-container {
      border: 1px solid #444;
      border-radius: var(--border-radius);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background-color: var(--bg-tertiary);
      margin-top: 15px;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: var(--border-radius);
      max-width: 80%;
      word-break: break-word;
    }

    .message-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .message.received {
      background-color: #2a2a2a;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }

    .message.sent {
      background-color: var(--accent);
      align-self: flex-end;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }

    .message-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .message-input {
      flex-grow: 1;
      margin: 0;
    }

    .connection-status {
      font-size: 0.9rem;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .status-disconnected {
      background-color: rgba(255, 82, 82, 0.2);
      color: #ff5252;
    }

    .status-connected {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .status-icon {
      margin-right: 6px;
      font-size: 0.8rem;
    }

    .messages {
      display: flex;
      flex-direction: column;
    }

    .system-message {
      text-align: center;
      color: var(--text-secondary);
      margin: 10px 0;
      font-style: italic;
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      margin-bottom: 15px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      background-color: var(--bg-tertiary);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .tab.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }

    .tab:hover:not(.active) {
      background-color: #353535;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .input-error {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .input-error.visible {
      display: block;
    }

    .room-display {
      background-color: var(--bg-tertiary);
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-code {
      font-weight: bold;
      color: var(--accent);
    }

    .user-info {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--bg-secondary);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      box-shadow: var(--card-shadow);
      z-index: 10;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }

    .sender-name {
      font-weight: bold;
      margin-right: 6px;
      color: var(--accent);
    }

    /* Screen sharing styles */
    .screen-container {
      position: relative;
      width: 100%;
      background-color: var(--bg-tertiary);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .screen-video {
      width: 100%;
      display: block;
    }

    .screen-controls {
      padding: 10px;
      background-color: var(--bg-tertiary);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      display: flex;
      justify-content: space-between;
    }

    .screen-placeholder {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-style: italic;
    }

    .btn-danger {
      background-color: var(--error);
    }

    .btn-danger:hover {
      background-color: #ff7575;
    }

    .share-options {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .mini-tab {
      border-radius: var(--border-radius);
      padding: 5px 10px;
      background-color: var(--bg-tertiary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .mini-tab.active {
      background-color: var(--accent);
      color: white;
    }

    .screen-sharing-notice {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: var(--error);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      animation: pulse 2s infinite;
      z-index: 5;
    }

    .screen-sharing-notice i {
      margin-right: 5px;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }

    @media (max-width: 600px) {
      .btn-group {
        flex-direction: column;
      }

      .message {
        max-width: 90%;
      }

      .tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">SendIt</div>
      <p class="tagline">Secure P2P Messaging & File Sharing</p>
    </header>

    <div id="setup-card" class="card">
      <div class="connection-status status-disconnected">
        <span class="status-icon"><i class="fas fa-circle"></i></span>
        <span id="connection-text">Not connected</span>
      </div>

      <div class="tabs">
        <div class="tab active" id="create-tab" onclick="switchTab('create')">
          <i class="fas fa-plus-circle"></i> Create Room
        </div>
        <div class="tab" id="join-tab" onclick="switchTab('join')">
          <i class="fas fa-sign-in-alt"></i> Join Room
        </div>
      </div>

      <div id="create-content" class="tab-content active">
        <h2><i class="fas fa-user-plus"></i> Create a Room</h2>
        <div class="input-group">
          <input id="host-username" placeholder="Enter your username (e.g. alex123)">
          <div id="username-error" class="input-error">This username is already taken</div>
        </div>
        <button class="btn" onclick="createRoom()">
          <i class="fas fa-door-open"></i> Create Room
        </button>

        <div id="room-info" style="display: none;">
          <div class="room-display">
            <div>
              <div>Room Code:</div>
              <div class="room-code" id="room-code">Not created yet</div>
            </div>
            <button class="copy-btn" onclick="copyRoomCode()">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <p>Share this code with others to let them join your room</p>
        </div>
      </div>

      <div id="join-content" class="tab-content">
        <h2><i class="fas fa-sign-in-alt"></i> Join a Room</h2>
        <div class="input-group">
          <input id="guest-username" placeholder="Enter your username (optional)">
        </div>
        <div class="input-group">
          <input id="room-code-input" placeholder="Enter room code">
        </div>
        <button class="btn" onclick="joinRoom()">
          <i class="fas fa-door-open"></i> Join Room
        </button>
      </div>
    </div>

    <div id="chat-card" class="card" style="display: none;">
      <div id="user-info" class="user-info">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <span id="display-username">Not Set</span>
      </div>

      <!-- Screen Sharing Card -->
      <div id="screen-sharing-card" class="card">
        <h2><i class="fas fa-desktop"></i> Screen Sharing</h2>

        <div class="screen-container" id="screen-container">
          <div id="screen-placeholder" class="screen-placeholder">
            <div>No screen is being shared</div>
          </div>
          <video id="shared-screen" class="screen-video" autoplay playsinline style="display: none;"></video>
          <div id="screen-sharing-notice" class="screen-sharing-notice" style="display: none;">
            <i class="fas fa-broadcast-tower"></i> You are sharing your screen
          </div>
        </div>

        <!-- <div class="share-options">
          <div class="mini-tab active" id="entire-screen-tab" onclick="selectShareOption('entire-screen')">
            <i class="fas fa-desktop"></i> Entire Screen
          </div>
          <div class="mini-tab" id="window-tab" onclick="selectShareOption('window')">
            <i class="far fa-window-maximize"></i> Window
          </div>
          <div class="mini-tab" id="tab-tab" onclick="selectShareOption('tab')">
            <i class="fas fa-browser"></i> Browser Tab
          </div>
        </div> -->

        <div class="screen-controls">
          <button class="btn" id="start-share-btn" onclick="startScreenShare()">
            <i class="fas fa-share-square"></i> Share Screen
          </button>
          <button class="btn btn-danger" id="stop-share-btn" onclick="stopScreenShare()" style="display: none;">
            <i class="fas fa-stop-circle"></i> Stop Sharing
          </button>
        </div>
      </div>

      <h2><i class="fas fa-comment-alt"></i> Messages</h2>
      <div class="message-container" id="messages">
        <div class="messages"></div>
      </div>

      <div class="message-form">
        <input id="message" class="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
        <button class="btn" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>

      <button class="btn" style="margin-top: 10px;" onclick="leaveRoom()">
        <i class="fas fa-sign-out-alt"></i> Leave Room
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
let peer = null;
let connections = []; // Array to store all connections (host and guests)
let username = '';
let isRoomCreator = false;
let localStream = null;
let shareOption = 'entire-screen';

// Screen share variables
let isScreenSharing = false;
let screenSharingPeerId = null;

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.getElementById(`${tabName}-content`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
}

// function selectShareOption(option) {
//   shareOption = option;
//   document.querySelectorAll('.mini-tab').forEach(tab => {
//     tab.classList.remove('active');
//   });
//   document.getElementById(`${option}-tab`).classList.add('active');
// }

async function startScreenShare() {
  if (isScreenSharing) return;

  try {
    let displayMediaOptions = { video: true, audio: true };

    // Apply different constraints based on selected option
    if (shareOption === 'entire-screen') {
      displayMediaOptions = { video: { displaySurface: 'monitor' }, audio: true };
    } else if (shareOption === 'window') {
      displayMediaOptions = { video: { displaySurface: 'window' }, audio: true };
    } else if (shareOption === 'tab') {
      displayMediaOptions = { video: { displaySurface: 'browser' }, audio: true };
    }

    localStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);

    // Display local stream
    const sharedScreen = document.getElementById('shared-screen');
    document.getElementById('screen-placeholder').style.display = 'none';
    sharedScreen.style.display = 'block';
    sharedScreen.srcObject = localStream;

    // Show screen sharing notice
    document.getElementById('screen-sharing-notice').style.display = 'flex';

    // Toggle buttons
    document.getElementById('start-share-btn').style.display = 'none';
    document.getElementById('stop-share-btn').style.display = 'inline-flex';

    isScreenSharing = true;
    screenSharingPeerId = peer.id;

    // Create a video call to EACH peer
    connections.forEach(conn => {
      if (conn.open) {
        // First notify peers that screen sharing is starting
        conn.send({
          type: 'screenShareStarting',
          peerId: peer.id,
          username: username
        });

        // Then call them with the video stream
        const call = peer.call(conn.peer, localStream, { metadata: { type: 'screenShare', username } });
        setupCallEvents(call);
      }
    });

    // Listen for stream end events
    localStream.getVideoTracks()[0].addEventListener('ended', () => {
      stopScreenShare();
    });

    addSystemMessage('You started sharing your screen');
  } catch (err) {
    console.error('Error starting screen share:', err);
    addSystemMessage('Failed to share screen: ' + err.message);
  }
}

function stopScreenShare() {
  if (!isScreenSharing || !localStream) return;

  // Stop all tracks
  localStream.getTracks().forEach(track => track.stop());
  localStream = null;

  // Update UI
  document.getElementById('shared-screen').style.display = 'none';
  document.getElementById('shared-screen').srcObject = null;
  document.getElementById('screen-placeholder').style.display = 'flex';
  document.getElementById('screen-sharing-notice').style.display = 'none';
  document.getElementById('start-share-btn').style.display = 'inline-flex';
  document.getElementById('stop-share-btn').style.display = 'none';

  isScreenSharing = false;

  // Notify all peers that screen sharing has stopped
  connections.forEach(conn => {
    if (conn.open) {
      conn.send({
        type: 'screenShareStopped',
        peerId: peer.id,
        username: username
      });
    }
  });

  addSystemMessage('You stopped sharing your screen');
}

// Setup call events for both initiator and receiver
function setupCallEvents(call) {
  call.on('stream', (remoteStream) => {
    // Display the remote stream if it's a screen share
    if (call.metadata?.type === 'screenShare') {
      const sharedScreen = document.getElementById('shared-screen');
      document.getElementById('screen-placeholder').style.display = 'none';
      sharedScreen.style.display = 'block';
      sharedScreen.srcObject = remoteStream;
      screenSharingPeerId = call.peer;

      addSystemMessage(`${call.metadata.username || 'Someone'} is sharing their screen`);
    }
  });

  call.on('close', () => {
    if (call.metadata?.type === 'screenShare' && screenSharingPeerId === call.peer) {
      document.getElementById('shared-screen').style.display = 'none';
      document.getElementById('shared-screen').srcObject = null;
      document.getElementById('screen-placeholder').style.display = 'flex';
      screenSharingPeerId = null;

      addSystemMessage(`${call.metadata.username || 'Someone'} stopped sharing their screen`);
    }
  });

  call.on('error', (err) => {
    console.error('Call error:', err);
    addSystemMessage('Screen sharing error: ' + err.message);
  });
}

function createRoom() {
  username = document.getElementById('host-username').value.trim();
  if (!username) {
    document.getElementById('username-error').textContent = 'Please enter a username';
    document.getElementById('username-error').classList.add('visible');
    return;
  }

  isRoomCreator = true;

  if (peer) {
    peer.destroy();
  }

  const roomCode = username;
  peer = new Peer(roomCode, {
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  });

  peer.on('open', (id) => {
    document.getElementById('room-code').textContent = roomCode;
    document.getElementById('room-info').style.display = 'block';
    document.getElementById('display-username').textContent = username;
    addSystemMessage(`Room created! Your room code: ${roomCode}`);
    updateConnectionStatus('waiting');
  });

  peer.on('error', (err) => {
    if (err.type === 'unavailable-id') {
      document.getElementById('username-error').textContent = 'Username already taken. Try another username.';
      document.getElementById('username-error').classList.add('visible');
    } else {
      addSystemMessage(`Error: ${err.type} - ${err.message}`);
    }
    updateConnectionStatus('error');
  });

  peer.on('connection', (connection) => {
    setupConnection(connection);
    connections.push(connection);
    const guestUsername = connection.metadata ? connection.metadata.username : 'Guest';
    addSystemMessage(`${guestUsername} has joined the room!`);
    updateConnectionStatus('connected');

    // Send current peer list to the new guest
    const peerList = connections.map(conn => ({
      peerId: conn.peer,
      username: conn.metadata ? conn.metadata.username : 'Guest'
    }));
    connection.send({
      type: 'peerList',
      peers: peerList
    });

    // Notify other guests about the new peer
    connections.forEach(conn => {
      if (conn !== connection && conn.open) {
        conn.send({
          type: 'newPeer',
          peerId: connection.peer,
          username: guestUsername
        });
      }
    });

    document.getElementById('setup-card').style.display = 'none';
    document.getElementById('chat-card').style.display = 'block';
  });

  // Handle incoming calls (for screen sharing)
  peer.on('call', (call) => {
    // Always answer screen sharing calls
    call.answer(); // Answer without sending a stream back
    setupCallEvents(call);
  });
}

function joinRoom() {
  const roomCode = document.getElementById('room-code-input').value.trim();
  if (!roomCode) {
    addSystemMessage('Please enter a room code.');
    return;
  }

  username = document.getElementById('guest-username').value.trim();
  if (!username) {
    username = 'Guest' + Math.floor(Math.random() * 1000);
  }

  document.getElementById('display-username').textContent = username;

  if (peer) {
    peer.destroy();
  }

  // Generate a random unique ID for this guest to prevent collisions
  const guestId = `guest_${username}_${Math.random().toString(36).substring(2, 8)}`;
  peer = new Peer(guestId, {
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  });

  peer.on('open', (id) => {
    const conn = peer.connect(roomCode, {
      metadata: { username }
    });
    connections.push(conn);
    setupConnection(conn);
    addSystemMessage(`Joining room ${roomCode}...`);
    updateConnectionStatus('connecting');
  });

  peer.on('connection', (connection) => {
    // Only add if not already in connections
    if (!connections.some(c => c.peer === connection.peer)) {
      setupConnection(connection);
      connections.push(connection);
      const guestUsername = connection.metadata ? connection.metadata.username : 'Guest';
      addSystemMessage(`${guestUsername} has connected to you!`);
      updateConnectionStatus('connected');
    }
  });

  // Handle incoming calls (for screen sharing)
  peer.on('call', (call) => {
    // Always answer screen sharing calls
    call.answer(); // Answer without sending a stream back
    setupCallEvents(call);
  });

  peer.on('error', (err) => {
    addSystemMessage(`Error: ${err.type} - ${err.message}`);
    if (err.type === 'peer-unavailable') {
      addSystemMessage('Room not found. Check the code and try again.');
    }
    updateConnectionStatus('error');
  });
}

function setupConnection(connection) {
  connection.on('open', () => {
    addSystemMessage('Connection established!');
    updateConnectionStatus('connected');
    document.getElementById('setup-card').style.display = 'none';
    document.getElementById('chat-card').style.display = 'block';
  });

  connection.on('data', (data) => {
    if (typeof data === 'object') {
      if (data.type === 'message') {
        addReceivedMessage(data.text, data.sender);
      } else if (data.type === 'system') {
        addSystemMessage(data.message);
      } else if (data.type === 'peerList') {
        // Guest receives list of peers to connect to
        data.peers.forEach(peerInfo => {
          if (peerInfo.peerId !== peer.id && !connections.some(c => c.peer === peerInfo.peerId)) {
            const conn = peer.connect(peerInfo.peerId, {
              metadata: { username }
            });
            connections.push(conn);
            setupConnection(conn);
          }
        });
      } else if (data.type === 'newPeer') {
        // Connect to new peer
        if (data.peerId !== peer.id && !connections.some(c => c.peer === data.peerId)) {
          const conn = peer.connect(data.peerId, {
            metadata: { username }
          });
          connections.push(conn);
          setupConnection(conn);
          addSystemMessage(`${data.username} has joined the room!`);
        }
      } else if (data.type === 'peerLeft') {
        // Remove peer from connections
        connections = connections.filter(conn => conn.peer !== data.peerId);
        addSystemMessage(`${data.username} has left the room.`);
      } else if (data.type === 'screenShareStarting') {
        addSystemMessage(`${data.username || 'Someone'} is starting to share their screen...`);
        // No need to do anything else here - the actual media will come through a call
      } else if (data.type === 'screenShareStopped') {
        // Only update if this peer was the one sharing
        if (screenSharingPeerId === data.peerId) {
          document.getElementById('shared-screen').style.display = 'none';
          document.getElementById('shared-screen').srcObject = null;
          document.getElementById('screen-placeholder').style.display = 'flex';
          screenSharingPeerId = null;
          addSystemMessage(`${data.username || 'Someone'} stopped sharing their screen`);
        }
      }
    } else {
      addReceivedMessage(data, connection.metadata?.username || 'Unknown');
    }
  });

  connection.on('close', () => {
    connections = connections.filter(conn => conn !== connection);
    addSystemMessage(`${connection.metadata?.username || 'A user'} has disconnected.`);
    updateConnectionStatus(connections.length > 0 ? 'connected' : 'disconnected');

    // Notify others if host
    if (isRoomCreator) {
      connections.forEach(conn => {
        if (conn.open) {
          conn.send({
            type: 'peerLeft',
            peerId: connection.peer,
            username: connection.metadata?.username || 'Guest'
          });
        }
      });
    }

    // If the disconnected peer was sharing screen, reset the screen sharing view
    if (screenSharingPeerId === connection.peer) {
      document.getElementById('shared-screen').style.display = 'none';
      document.getElementById('shared-screen').srcObject = null;
      document.getElementById('screen-placeholder').style.display = 'flex';
      screenSharingPeerId = null;
      addSystemMessage(`${connection.metadata?.username || 'Someone'} stopped sharing their screen (disconnected)`);
    }
  });
}

function leaveRoom() {
  // Stop screen sharing if active
  if (isScreenSharing) {
    stopScreenShare();
  }

  connections.forEach(conn => conn.close());
  if (peer) {
    peer.destroy();
    peer = null;
  }
  connections = [];

  document.getElementById('setup-card').style.display = 'block';
  document.getElementById('chat-card').style.display = 'none';
  document.querySelector('.messages').innerHTML = '';
  document.getElementById('room-info').style.display = 'none';
  document.getElementById('username-error').classList.remove('visible');
  document.getElementById('host-username').value = '';
  document.getElementById('guest-username').value = '';
  document.getElementById('room-code-input').value = '';

  updateConnectionStatus('disconnected');
  addSystemMessage('You left the room');
}

function sendMessage() {
  const message = document.getElementById('message').value.trim();
  if (!message) return;

  if (connections.length > 0) {
    connections.forEach(conn => {
      if (conn.open) {
        conn.send({
          type: 'message',
          text: message,
          sender: username
        });
      }
    });
    addSentMessage(message);
    document.getElementById('message').value = '';
  } else {
    addSystemMessage('Not connected to any peers.');
  }
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
}

function copyRoomCode() {
  const roomCode = document.getElementById('room-code').textContent;
  if (roomCode && roomCode !== 'Not created yet') {
    navigator.clipboard.writeText(roomCode)
      .then(() => addSystemMessage('Room code copied to clipboard!'))
      .catch(err => addSystemMessage('Failed to copy: ' + err));
  }
}

function updateConnectionStatus(status) {
  const statusElement = document.querySelector('.connection-status');
  const statusTextElement = document.getElementById('connection-text');
  statusElement.className = 'connection-status';

  switch(status) {
    case 'connected':
      statusElement.classList.add('status-connected');
      statusTextElement.textContent = 'Connected';
      break;
    case 'connecting':
      statusElement.classList.add('status-disconnected');
      statusTextElement.textContent = 'Connecting...';
      break;
    case 'waiting':
      statusElement.classList.add('status-disconnected');
      statusTextElement.textContent = 'Waiting for someone to join';
      break;
    case 'error':
      statusElement.classList.add('status-disconnected');
      statusTextElement.textContent = 'Connection error';
      break;
    default:
      statusElement.classList.add('status-disconnected');
      statusTextElement.textContent = 'Not connected';
  }
}

function addSystemMessage(text) {
  const messagesEl = document.querySelector('.messages');
  const messageEl = document.createElement('div');
  messageEl.className = 'system-message';
  messageEl.textContent = text;
  messagesEl.appendChild(messageEl);
  scrollToBottom();
}

function addReceivedMessage(text, senderName) {
  const messagesEl = document.querySelector('.messages');
  const messageEl = document.createElement('div');
  messageEl.className = 'message received';

  if (senderName) {
    const senderEl = document.createElement('div');
    senderEl.className = 'sender-name';
    senderEl.textContent = senderName;
    messageEl.appendChild(senderEl);
  }

  const contentEl = document.createElement('div');
  contentEl.textContent = text;
  messageEl.appendChild(contentEl);

  const timeEl = document.createElement('div');
  timeEl.className = 'message-time';
  timeEl.textContent = getCurrentTime();
  messageEl.appendChild(timeEl);

  messagesEl.appendChild(messageEl);
  scrollToBottom();
}

function addSentMessage(text) {
  const messagesEl = document.querySelector('.messages');
  const messageEl = document.createElement('div');
  messageEl.className = 'message sent';

  const contentEl = document.createElement('div');
  contentEl.textContent = text;
  messageEl.appendChild(contentEl);

  const timeEl = document.createElement('div');
  timeEl.className = 'message-time';
  timeEl.textContent = getCurrentTime();
  messageEl.appendChild(timeEl);

  messagesEl.appendChild(messageEl);
  scrollToBottom();
}

function getCurrentTime() {
  const now = new Date();
  let hours = now.getHours();
  let minutes = now.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  minutes = minutes < 10 ? '0' + minutes : minutes;
  return `${hours}:${minutes} ${ampm}`;
}

function scrollToBottom() {
  const container = document.getElementById('messages');
  container.scrollTop = container.scrollHeight;
}
  </script>
</body>
</html>